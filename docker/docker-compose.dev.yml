# =============================================================================
# Backend Services - Development Environment Configuration
# =============================================================================
# 开发环境配置，覆盖 base.yml 中的配置
#
# 使用方式：
#   podman-compose -f docker-compose.base.yml -f docker-compose.dev.yml up
#   或
#   ./deploy.sh dev up
#
# 开发环境特点：
#   - 所有端口映射到 localhost，便于调试
#   - 使用 build 从源码构建镜像
#   - 启用调试模式和详细日志
#   - 不设置自动重启策略（手动控制）
# =============================================================================

version: "3.8"

services:
  # ===========================================================================
  # 基础设施服务 - 开发环境配置
  # ===========================================================================

  postgres:
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    # 开发环境不自动重启，方便调试
    restart: "no"

  etcd:
    ports:
      - "${ETCD_PORT:-2379}:2379"
    restart: "no"

  rustfs:
    ports:
      - "${RUSTFS_API_PORT:-9000}:9000"
      - "${RUSTFS_CONSOLE_PORT:-9001}:9001"
    restart: "no"

  # ===========================================================================
  # 应用服务 - 开发环境配置
  # ===========================================================================

  identity_srv:
    # 从源码构建镜像
    build:
      context: ../rpc/identity_srv
      dockerfile: docker/Dockerfile
    image: identity-srv:dev
    ports:
      - "${IDENTITY_SRV_PORT:-8891}:8891"
      - "${IDENTITY_HEALTH_PORT:-10000}:10000"
    restart: "no"
    # 开发环境覆盖环境变量
    environment:
      APP_ENVIRONMENT: development
      APP_DEBUG: "true"
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      ERROR_HANDLER_ENABLE_DETAILED_ERRORS: "true"

  api_gateway:
    # 从源码构建镜像
    build:
      context: ..
      dockerfile: gateway/docker/Dockerfile
    image: gateway:dev
    ports:
      - "${API_GATEWAY_PORT:-8080}:8080"
    restart: "no"
    # 开发环境覆盖环境变量
    environment:
      APP_ENVIRONMENT: development
      APP_DEBUG: "true"
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      ERROR_HANDLER_ENABLE_DETAILED_ERRORS: "true"
      JWT_COOKIE_SECURE_COOKIE: "false"  # 开发环境可以使用 HTTP
